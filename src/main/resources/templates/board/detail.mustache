{{> header}}

<div class="container p-5">

    {{#model.isOwner}}
    <!-- ìˆ˜ì •ì‚­ì œë²„íŠ¼ -->
    <div class="d-flex justify-content-end">
        <a href="/boards/{{model.id}}/update-form" class="btn btn-secondary me-1">ìˆ˜ì •</a>
        <form action = "/boards/{{model.id}}/delete" method = "post">
        <button class="btn btn-outline-secondary">ì‚­ì œ</button>
        </form>
    </div>
    {{/model.isOwner}}
    <!-- ê²Œì‹œê¸€ë‚´ìš© -->
    <div>
        <h2><b>{{model.title}}</b></h2>
        <hr />
        <div class="d-flex justify-content-end">
            ì‘ì„±ì : {{model.username}}
        </div>
        <div class="m-4 p-2">  
            {{&model.content}}
            
        </div>
    </div>

    <!-- ëŒ“ê¸€ -->
    <div class="card mt-3">

    
        <!-- ëŒ“ê¸€ë“±ë¡ -->
        <div class="card-body">
            <form> 
                <input type="hidden" id="boardId" value="{{model.id}}">
                <textarea class="form-control" rows="2" id="replyComment"></textarea>
                    <div class="d-flex justify-content-end">
                         <button type="button" class="btn btn-secondary mt-1" onclick="saveReply()">
                             ëŒ“ê¸€ë“±ë¡
                         </button>
                    </div>
            </form>
        </div>

        <!-- ëŒ“ê¸€ëª©ë¡ -->
       <div class="card-footer">
            <b>ëŒ“ê¸€ë¦¬ìŠ¤íŠ¸</b>
        </div>
        <div class="list-group" id="reply-box"> 

        {{#model.replies}}
        <!-- ëŒ“ê¸€ì•„ì´í…œ -->
            <div class="list-group-item d-flex justify-content-between align-items-center">
                <div class="d-flex">
                    <div class="px-1 me-1 bg-secondary text-white rounded">{{replyUsername}}</div>
                    <div>{{comment}}</div>
                </div>

                {{#isReplyOwner}}
                <form action="/replies/{{id}}/delete?boardId={{model.id}}" method="post">
                    <button class="btn">ğŸ—‘</button>
                </form>
                {{/isReplyOwner}}
                
            </div>
        {{/model.replies}}

        </div>
    </div>
</div>


<script>
    // [ëŒ“ê¸€ ë“±ë¡]
    async function saveReply() {
        let requestBody = {
            boardId: document.querySelector("#boardId").value,
            comment: document.querySelector("#replyComment").value
        };

        let response = await fetch("/api/replies/save", {
            method: "post",
            headers: { "Content-Type": "application/json; charset=utf-8" },
            body: JSON.stringify(requestBody)
        });

        if (response.status === 201) { // ì„±ê³µ
            let replyDTO = await response.json();
            let replyHtml = `
                <div id="reply-${replyDTO.id}" class="list-group-item d-flex justify-content-between align-items-center">
                    <div class="d-flex">
                        <div class="px-1 me-1 bg-secondary text-white rounded">${replyDTO.replyUsername}</div>
                        <div>${replyDTO.comment}</div>
                    </div>
                    <button onclick="deleteReply(${replyDTO.id})" class="btn">ğŸ—‘</button>
                </div>`;
            document.querySelector("#reply-box").insertAdjacentHTML("afterbegin", replyHtml);
            document.querySelector("#replyComment").value = "";

        } else if (response.status === 400) { // ìœ íš¨ì„± ê²€ì‚¬ ì‹¤íŒ¨ (ê³µë°± ë“±)
            let msg = await response.text();
            alert(msg); 
        } else if (response.status === 401) { // ë¡œê·¸ì¸ ì•ˆë¨
            alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
            location.href = "/login-form";
        } else if (response.status === 404) { // ê²Œì‹œê¸€ ì—†ìŒ
            let msg = await response.text();
            alert(msg);
        } else {
            alert("ì˜¤ë¥˜ ë°œìƒ: " + response.status);
        }
    }

    // [ëŒ“ê¸€ ì‚­ì œ]
    async function deleteReply(replyId) {
        let response = await fetch(`/api/replies/${replyId}/delete`, {
            method: "post"
        });

        if (response.status === 200) { // ì„±ê³µ
            // í™”ë©´ì—ì„œ ë°”ë¡œ ì œê±°
            let element = document.querySelector(`#reply-${replyId}`);
            if (element) element.remove();

        } else if (response.status === 401) {
            alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
            location.href = "/login-form";
        } else if (response.status === 403) {
            let msg = await response.text();
            alert(msg); // "ì‘ì„±ìë§Œ ì‚­ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤" ë“±
        } else if (response.status === 404) {
            alert("ì´ë¯¸ ì‚­ì œëœ ëŒ“ê¸€ì´ê±°ë‚˜ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
        } else {
            alert("ì‚­ì œ ì‹¤íŒ¨: " + response.status);
        }
    }
</script>

</body>

</html>