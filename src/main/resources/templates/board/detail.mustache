{{> header}}

<div class="container p-5">

    {{#model.isOwner}}
    <!-- ìˆ˜ì •ì‚­ì œë²„íŠ¼ -->
    <div class="d-flex justify-content-end">
        <a href="/boards/{{model.id}}/update-form" class="btn btn-secondary me-1">ìˆ˜ì •</a>
        <form action = "/boards/{{model.id}}/delete" method = "post">
        <button class="btn btn-outline-secondary">ì‚­ì œ</button>
        </form>
    </div>
    {{/model.isOwner}}
    <!-- ê²Œì‹œê¸€ë‚´ìš© -->
    <div>
        <h2><b>{{model.title}}</b></h2>
        <hr />
        <div class="d-flex justify-content-end">
            ì‘ì„±ì : {{model.username}}
        </div>
        <div class="m-4 p-2">  
            {{&model.content}}
            
        </div>
    </div>

    <!-- ëŒ“ê¸€ -->
    <div class="card mt-3">

    
        <!-- ëŒ“ê¸€ë“±ë¡ -->
        <div class="card-body">
            <form> 
                <input type="hidden" id="boardId" value="{{model.id}}">
                <textarea class="form-control" rows="2" id="replyComment"></textarea>
                    <div class="d-flex justify-content-end">
                         <button type="button" class="btn btn-secondary mt-1" onclick="saveReply()">
                             ëŒ“ê¸€ë“±ë¡
                         </button>
                    </div>
            </form>
        </div>

        <!-- ëŒ“ê¸€ëª©ë¡ -->
       <div class="card-footer">
            <b>ëŒ“ê¸€ë¦¬ìŠ¤íŠ¸</b>
        </div>
        <div class="list-group" id="reply-box"> 

        {{#model.replies}}
        <!-- ëŒ“ê¸€ì•„ì´í…œ -->
            <div class="list-group-item d-flex justify-content-between align-items-center">
                <div class="d-flex">
                    <div class="px-1 me-1 bg-secondary text-white rounded">{{replyUsername}}</div>
                    <div>{{comment}}</div>
                </div>

                {{#isReplyOwner}}
                <form action="/replies/{{id}}/delete?boardId={{model.id}}" method="post">
                    <button class="btn">ğŸ—‘</button>
                </form>
                {{/isReplyOwner}}
                
            </div>
        {{/model.replies}}

        </div>
    </div>
</div>


<script>
    async function saveReply() {
        // 1. ê°’ ê°€ì ¸ì˜¤ê¸°
        let requestBody = {
            boardId: document.querySelector("#boardId").value,
            comment: document.querySelector("#replyComment").value
        };

        // 2. ì„œë²„ ì „ì†¡
        let response = await fetch("/api/replies/save", {
            method: "post",
            headers: {
                "Content-Type": "application/json; charset=utf-8"
            },
            body: JSON.stringify(requestBody)
        });

        // 3. ê²°ê³¼ ì²˜ë¦¬
        if (response.status === 201) { // ì„±ê³µ
            let replyDTO = await response.json();
            
            let replyHtml = `
                <div class="list-group-item d-flex justify-content-between align-items-center">
                    <div class="d-flex">
                        <div class="px-1 me-1 bg-secondary text-white rounded">${replyDTO.replyUsername}</div>
                        <div>${replyDTO.comment}</div>
                    </div>
                    <form action="/replies/${replyDTO.id}/delete?boardId=${requestBody.boardId}" method="post">
                        <button class="btn">ğŸ—‘</button>
                    </form>
                </div>
            `;

            document.querySelector("#reply-box").insertAdjacentHTML("afterbegin", replyHtml);
            document.querySelector("#replyComment").value = "";

        } else if (response.status === 401) { // ì¸ì¦ ì‹¤íŒ¨
            alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
            location.href = "/login-form";
            
        } else {
            // [ì¤‘ìš”] ì •í™•í•œ ì—ëŸ¬ í™•ì¸ì„ ìœ„í•´ ìƒíƒœ ì½”ë“œë¥¼ ë„ì›ë‹ˆë‹¤.
            alert("ì˜¤ë¥˜ ë°œìƒ: " + response.status); 
        }
    }
</script>

</body>

</html>